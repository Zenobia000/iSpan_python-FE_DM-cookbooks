# 模組八講義：時間序列特徵工程 (Time Series Feature Engineering)

---

## 1. 本章學習框架 (Learning Framework)

- **第一原理 (First Principle)**: **「時間的流逝本身就是一種信息。」** 在時間序列數據中，數據點的順序至關重要。傳統的機器學習模型假設樣本之間是獨立同分佈的，但時間序列數據打破了這個假設。時間序列特徵工程的核心任務，就是將時間的「上下文」和「依賴性」明確地編碼成特徵，讓標準的機器學習模型也能理解和利用這些時間動態。

- **基礎 (Fundamentals)**: 本章節將教授從時間序列數據中提取信號的四大核心技術：
  1.  **滯後特徵 (Lag Features)**: 讓模型「回看」過去。
  2.  **滑動窗口特徵 (Rolling Window Features)**: 捕捉近期的趨勢與波動。
  3.  **日期時間特徵 (Date-Time Features)**: 從時間戳中解構週期性模式。
  4.  **趨勢與季節性分解 (Trend and Seasonality Decomposition)**: 系統性地分離信號的組成部分。

---

## 2. 滯後特徵 (Lag Features)

> *「使用一個時間點之前（t-n）的觀測值，作為預測當前時間點（t）的特徵。」*

- **核心思想**: 一個時間點的數值，往往與其緊鄰的前幾個時間點的數值高度相關。這種現象稱為「自我相關」(Autocorrelation)。滯後特徵就是將這種自我相關性直接轉化為模型的輸入。
- **實現方式**:
  - `pandas` 中的 `shift()` 函數是實現滯後特徵的利器。
  - `df['sales_lag_1'] = df['sales'].shift(1)`: 創建一個新特徵，其在 `t` 時刻的值等於 `sales` 在 `t-1` 時刻的值。
- **應用場景**:
  - 幾乎所有時間序列預測問題的基礎。
  - 幫助模型捕捉動量 (Momentum) 和短期依賴性。
- **注意事項**: `shift()` 操作會在數據的開頭產生 `NaN` 值，在將數據送入模型前需要妥善處理（例如，填充或刪除）。

---

## 3. 滑動窗口特徵 (Rolling Window Features)

> *「計算在一個固定大小的移動窗口內數據的統計摘要，以平滑短期波動並捕捉局部趨勢。」*

- **核心思想**: 單一的滯後值可能充滿噪音，而一段時間內的統計值（如平均值）更能反映近期的真實狀態。
- **實現方式**:
  - `pandas` 中的 `rolling()` 方法是關鍵。
  - **計算移動平均**: `df['sales_roll_mean_7'] = df['sales'].rolling(window=7).mean()`: 計算過去7天的平均銷售額。
  - **常用統計量**: 除了 `mean()`，還可以計算 `std()` (波動性), `min()`, `max()`, `sum()` 等。
- **`expanding()` vs `rolling()`**:
  - **`rolling(n)`**: 固定大小的窗口，始終觀察過去 `n` 個時間點。更關注「近期」的動態。
  - **`expanding()`**: 窗口從起點開始，不斷擴大，包含至今為止所有的數據。更關注「累積」的總體趨勢。
- **應用場景**: 捕捉數據的局部趨勢、動量和波動性，是金融、物流行業中極其常用的技術。

---

## 4. 日期時間特徵 (Date-Time Features)

> *「將一個單一的時間戳分解為多個有意義的、具有週期性的數值成分。」*

- **核心思想**: 時間本身蘊含著多層次的週期性規律，如一天中的小時、一週中的星期幾、一年中的月份。將這些規律提取出來，可以幫助模型識別出與時間相關的模式（例如，週末銷量更高，夏季用電量更大）。
- **實現流程**:
  1.  **確保型態**: 使用 `pd.to_datetime()` 將欄位轉換為 `datetime64` 型態。
  2.  **使用 `.dt` 存取器**:
      - **基礎成分**: `.dt.year`, `.dt.month`, `.dt.day`, `.dt.hour`
      - **週期成分**: `.dt.dayofweek` (0=週一, 6=週日), `.dt.dayofyear`, `.dt.weekofyear`
      - **布林特徵**: `.dt.is_weekend`, `.dt.is_month_start`
- **注意事項**: 對於像 `dayofweek` 或 `month` 這樣的週期性特徵，有時需要進一步進行正弦/餘弦變換 (`sin`/`cos`)，以幫助模型理解其循環特性（例如，12月之後是1月）。

---

## 5. 趨勢與季節性分解 (Trend and Seasonality Decomposition)

> *「將一個複雜的時間序列，系統性地拆解為三個核心組成部分：趨勢、季節性和殘差。」*

- **核心思想**: 任何時間序列都可以被看作是幾個基本模式的疊加。
  - **趨勢 (Trend)**: 數據在長期內的總體方向（上升、下降或平穩）。
  - **季節性 (Seasonality)**: 在固定時間間隔內（如每年、每週）重複出現的模式。
  - **殘差 (Residual/Noise)**: 移除趨勢和季節性後，剩餘的隨機波動。
- **實現方式**:
  - `statsmodels` 是一個強大的統計分析庫。
  - `from statsmodels.tsa.seasonal import seasonal_decompose`
  - **模型類型**:
    - **加法模型 (Additive)**: `Y(t) = Trend(t) + Seasonal(t) + Residual(t)` (季節性波動的幅度不隨時間改變)。
    - **乘法模型 (Multiplicative)**: `Y(t) = Trend(t) * Seasonal(t) * Residual(t)` (季節性波動的幅度隨趨勢等比例變化)。
- **應用**: 分解本身就是一種強大的分析工具，可以幫助我們理解數據的內在驅動力。此外，我們可以對去除了季節性的數據進行建模，或者將趨勢和季節性本身作為特徵。

---

## 6. 總結

時間序列特徵工程是將傳統機器學習模型應用於時序問題的橋樑。

- **`滯後特徵`** 和 **`滑動窗口特徵`** 幫助模型理解數據的 **自我相關性** 和 **局部動態**。
- **`日期時間特徵`** 幫助模型捕捉與日曆相關的 **週期性模式**。
- **`分解`** 提供了一個宏觀視角，讓我們理解數據的 **長期趨勢** 和 **內在節律**。

在實際應用中，這些技術通常會結合使用，為模型提供一個關於時間的多維度、全方位的視圖。 